<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulk Address Verification</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#1D4ED8',
                        'secondary-green': '#059669',
                        'neutral-gray': '#E5E7EB',
                        'template-blue': '#DBEAFE',
                        'template-dark': '#1E40AF',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-neutral-gray min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-3xl bg-white p-8 sm:p-10 rounded-xl shadow-2xl">

        <!-- Back Link pointing to root (/) -->
        <a href="/" class="text-primary-blue hover:text-blue-700 font-medium mb-6 inline-flex items-center transition duration-150">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
            Back to Home
        </a>

        <header class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-gray-900 mb-2">
                <span class="text-secondary-green">Bulk Address</span> Verification
            </h1>
            <p class="text-gray-500">Upload a CSV file to process and standardize multiple addresses at once.</p>
        </header>

        <div class="space-y-8">
            <!-- Step 1: Download Template -->
            <div class="p-6 bg-template-blue rounded-lg border border-blue-300 shadow-md">
                <h3 class="text-xl font-bold text-template-dark mb-3 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    Step 1: Download Template
                </h3>
                <p class="text-gray-700 mb-4">Click the button below to get the required CSV template. Your file must have these columns: **ORDER ID, CUSTOMER NAME, CUSTOMER RAW ADDRESS**.</p>
                <button id="downloadTemplateButton" class="px-6 py-3 bg-template-dark text-white font-bold rounded-lg hover:bg-blue-900 transition duration-200 shadow-lg focus:outline-none focus:ring-4 focus:ring-template-dark focus:ring-opacity-50">
                    Download Template (CSV)
                </button>
            </div>

            <!-- Step 2: Upload and Process -->
            <div class="p-6 border-2 border-dashed border-gray-300 rounded-lg bg-white shadow-md">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-secondary-green" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.888-7.903A5 5 0 1115.903 8.35L16 8a5 5 0 014 4v2m-6 3a4 4 0 01-4-4"></path></svg>
                    Step 2: Upload File
                </h3>
                
                <div class="text-center mb-6">
                    <input type="file" id="csvFileInput" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary-blue/10 file:text-primary-blue hover:file:bg-primary-blue/20 transition duration-150">
                    <p class="text-xs text-gray-400 mt-2">Max 1000 rows recommended for stability.</p>
                </div>
                
                <button id="processButton" class="w-full py-3 bg-secondary-green text-white font-bold rounded-lg shadow-xl hover:bg-green-700 transition duration-200 transform hover:scale-[1.00] focus:outline-none focus:ring-4 focus:ring-secondary-green focus:ring-opacity-50" disabled>
                    Start Verification
                </button>
            </div>

            <!-- Step 3: Status and Download -->
            <div class="pt-4">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Verification Status</h3>
                
                <p id="status-message" class="text-gray-600 mb-3 font-medium">Ready to upload.</p>
                
                <div class="w-full h-4 bg-gray-200 rounded-full overflow-hidden shadow-inner mb-4">
                    <div class="h-full bg-primary-blue transition-all duration-300 ease-out" id="progressBarFill" style="width: 0%"></div>
                </div>

                <a id="downloadLink" class="hidden w-full text-center py-3 bg-primary-blue text-white font-bold rounded-lg shadow-xl hover:bg-blue-800 transition duration-200 focus:outline-none focus:ring-4 focus:ring-primary-blue focus:ring-opacity-50 cursor-pointer">
                    Download Verified Addresses (CSV)
                </a>
            </div>
        </div>
    </div>
    
    <!-- JavaScript logic for bulk processing -->
    <script>
        const API_ENDPOINT = "https://address-verification-app.vercel.app/api/verify-single-address";

        document.addEventListener('DOMContentLoaded', () => {
            const downloadTemplateButton = document.getElementById('downloadTemplateButton');
            const csvFileInput = document.getElementById('csvFileInput');
            const processButton = document.getElementById('processButton');

            if (downloadTemplateButton) {
                downloadTemplateButton.addEventListener('click', handleTemplateDownload);
            }

            if (csvFileInput) {
                csvFileInput.addEventListener('change', () => {
                    if (processButton) {
                        processButton.disabled = !csvFileInput.files.length;
                        document.getElementById('status-message').textContent = csvFileInput.files.length ? `File selected: ${csvFileInput.files[0].name}. Ready to start.` : 'Ready to upload.';
                        document.getElementById('downloadLink').classList.add('hidden');
                        document.getElementById('progressBarFill').style.width = '0%';
                    }
                });
            }

            if (processButton) {
                processButton.addEventListener('click', handleBulkVerification);
            }
        });

        // --- Core Utility Functions ---

        function parseCSV(csvText) {
            const lines = csvText.split('\\n').filter(line => line.trim() !== '');
            if (lines.length === 0) return [];
            
            // Simple parsing assuming no complex quoting for now, expecting headers: ORDER ID, CUSTOMER NAME, CUSTOMER RAW ADDRESS
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim().replace(/^\"|\"$/g, ''));
                if (values.length >= 3) {
                    data.push({
                        orderId: values[0],
                        customerName: values[1],
                        rawAddress: values[2]
                    });
                }
            }
            return data;
        }

        function createAndDownloadCSV(rows, filename) {
            const header = "ORDER ID,CUSTOMER NAME (Original),CUSTOMER RAW ADDRESS (Original),CLEAN NAME,CLEAN ADDRESS LINE 1,LANDMARK,STATE,DISTRICT,PIN,REMARKS,ADDRESS QUALITY";
            const csvContent = [header, ...rows].join('\\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const downloadLink = document.getElementById('downloadLink');
            downloadLink.href = url;
            downloadLink.download = filename;
            downloadLink.classList.remove('hidden');
            downloadLink.textContent = 'Download Verified Addresses (CSV)';
        }

        async function fetchVerification(rawAddress, customerName) {
            const payload = { rawAddress, customerName };
            try {
                // Exponential backoff mechanism (1s, 2s, 4s retry delays)
                for (let i = 0; i < 3; i++) {
                    const response = await fetch(API_ENDPOINT, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) { // Too Many Requests
                        console.warn(`Rate limit hit. Retrying in ${Math.pow(2, i)} seconds...`);
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                        continue;
                    }
                    
                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(errorBody.error || `Server responded with status ${response.status}`);
                    }
                    
                    return await response.json();
                }
                throw new Error("Verification failed after multiple retries.");
            } catch (error) {
                console.error("Verification API Error:", error);
                return { 
                    status: "Error", 
                    error: `Verification failed: ${error.message}`,
                    remarks: `ERROR: ${error.message}`
                };
            }
        }

        // --- Handlers ---

        function handleTemplateDownload() {
            const template = "ORDER ID,CUSTOMER NAME,CUSTOMER RAW ADDRESS\\n1001,John Doe,H.No. 123, Sector 40B, Chandigarh\\n1002,Jane Smith,Near Police Station, Dadumajra, Chandigarh";
            const blob = new Blob([template], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'address_template.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function handleBulkVerification() {
            const fileInput = document.getElementById('csvFileInput');
            const processButton = document.getElementById('processButton');
            const progressBarFill = document.getElementById('progressBarFill');
            const statusMessage = document.getElementById('status-message');
            const downloadLink = document.getElementById('downloadLink');

            if (!fileInput.files.length) {
                statusMessage.textContent = 'Please select a CSV file first.';
                return;
            }

            const file = fileInput.files[0];
            processButton.disabled = true;
            fileInput.disabled = true;
            downloadLink.classList.add('hidden');
            progressBarFill.style.width = '0%';
            statusMessage.textContent = 'Reading file...';

            const reader = new FileReader();

            reader.onload = async function(e) {
                const csvText = e.target.result;
                const addresses = parseCSV(csvText);
                const totalAddresses = addresses.length;
                let processedCount = 0;
                const outputRows = [];

                if (totalAddresses === 0) {
                    statusMessage.textContent = 'Error: The file is empty or missing required data.';
                    processButton.disabled = false;
                    fileInput.disabled = false;
                    return;
                }
                
                // Process addresses sequentially to manage rate limits and ensure proper progress
                for (const addr of addresses) {
                    let verificationResult;
                    
                    // Simple check for obvious errors to skip API call if data is severely malformed
                    if (!addr.rawAddress || !addr.orderId) {
                        verificationResult = { status: "Error", remarks: "Skipped: Missing Order ID or Raw Address." };
                    } else {
                        verificationResult = await fetchVerification(addr.rawAddress, addr.customerName);
                    }

                    // Format the output row for the new CSV
                    const outputRow = [
                        addr.orderId,
                        addr.customerName,
                        addr.rawAddress,
                        verificationResult.customerCleanName || '',
                        verificationResult.addressLine1 || '',
                        verificationResult.landmark || '', // Landmark is expected in the full API response
                        verificationResult.state || '',
                        verificationResult.district || '',
                        verificationResult.pin || '',
                        verificationResult.remarks || verificationResult.error || '',
                        verificationResult.addressQuality || ''
                    ].map(cell => `\"${String(cell).replace(/\"/g, '\"\"')}\"`).join(','); // Escape quotes and wrap in quotes

                    outputRows.push(outputRow);
                    
                    processedCount++;
                    const progress = (processedCount / totalAddresses) * 100;
                    progressBarFill.style.width = `${progress}%`;
                    statusMessage.textContent = `Processing... ${processedCount} of ${totalAddresses} addresses completed.`;
                }

                statusMessage.textContent = `Processing complete! ${totalAddresses} addresses verified. Ready to download.`;
                createAndDownloadCSV(outputRows, "verified_addresses.csv");
                processButton.disabled = false;
                fileInput.disabled = false;
            };

            reader.onerror = function() {
                statusMessage.textContent = "Error reading file. Please try again.";
                processButton.disabled = false;
                fileInput.disabled = false;
            };

            reader.readAsText(file);
        }
    </script>
</body>
</html>
